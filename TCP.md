#1、TCP 传输控制协议
TCP为应用层提供一种面向连接的、可靠的字节流服务。

面向连接：
客户端和服务器在彼此交换数据之前必须先建立一个TCP连接，在一个连接中仅有两方进行彼此通信。

可靠性：
1、应用数据会被分割成TCP认为最适合发送的数据块，应用程序产生的数据报长度保持不变；
2、当TCP发出一个报文段之后，会启动一个定时器，等待目的端确认接收到这个报文段，如果不能够及时收到确认将重发这个报文段；
3、当TCP收到法子TCP连接另一端的数据后几分之一秒，会发送一个确认；
4、TCP会保持首部和数据的检验和，目的是检验数据在传输过程中的任何变化，如果收到报文段的检验和有差错，TCP将丢弃这个报文段而且不确认收到此报文段，并希望发送端超时且重发；
5、TCP的接收端会丢弃重复的数据；
6、TCP连接的每一方都有固定大小的缓冲空间，TCP的接收端只允许另一端发送接收端缓冲区所能接纳的数据，防止较快主机致使较慢主机的缓冲区溢出。


TCP对字节流的内容不作任何解释，对字节流的解释由TCP连接双方的应用层解释。

TCP报文段同IP首部被封装在一个IP数据报中。

TCP首部通常是20个字节：
16位、2个字节的源端口号；
16位、2个字节的没目的端口号；
32位、4个字节的序号：用来标识从TCP发端向TCP收端发送的数据字节流，表示在报文段中的第一个数据字节。
32位、4个字节的确认序号；
4位、半个字节的首部长度；
6位保留；
1位的URG（urgent pointer）：紧急指针有效；
1位的ACK（acknowledge）：确认序号有效，确认序号包含发送确认的一段所期望收到的下一个序号，确认序号应为上次已成功收到的数据字节序号+ACK，也就是+1；
1位的PSH（push）：接收方应该尽快推进，将这个报文段交给应用层；
1位的RST（reset）：重建连接；
1位的SYN（synchronize）：同步序号用来发起一个连接，SYN标志变为1，SEQ等于该连接的初始序号ISN（initial sequence number），发送数据的第一个字节序号为ISN+SYN，也就是ISN+1；
1位的FIN（finish）：发端完成发送任务；
16位、2个字节的窗口大小：TCP的流量控制由连接的每一端通过声明的窗口大小来提供，窗口大小为字节数，起始于确认序号字段指明的值，这个值是接收端正期望接收的字节。
16位、2个字节的检验和：检验和覆盖了整个TCP报文段，包括首部和数据，这是一个强制性字段，由发端计算和存储，并由收端进行验证。
16位、2个字节的紧急指针：当URG标志为1时有效，紧急指针是一个正的偏移量，和序号字段中的值相加表示紧急数据最后一个字节的序号，是发送端向另一端发送紧急数据的一种方式。

可选字段：
最常见的可选字段是最长报文大小：MSS（maximum segment size），每个连接方通常都在通信的第一个报文段，也就是为建立连接而设置SYN标识的那个段中指明这个选项，它指明本端所能接收的最大长度的报文段。

TCP报文段中的数据部分是可选的：一个连接建立和一个连接终止时，双方交换的报文段仅有TCP首部。



#2、TCP连接的建立与终止

源 > 目的: 标志 

开始序号:隐含的结尾序号(数据字节数)
只有在报文段中至少包含一个数据字节，或者SYN、FIN或RST被置为1时才显示。

ack 确认序号
只有在首部中的ack标志比特被置为1时才显示。

win 窗口大小
表示发端通告的窗口大小

<mss 最大报文段长度>
表示发端将不接收超过这个长度的TCP报文段，这通常是为了避免分段。


##2.1、three-way handshake
SYN报文段1：（客户端发送）在连接时应用，当SYN=1而ACK=0时，注解这是一个连接恳求报文段，并指明客户打算连接的服务器端口以及初始序号ISN也就是SEQ。

SYN报文段2：（服务端发送）服务器发回包含服务器初始序号ISN也就是SEQ的报文段作为应答，同时将确认序号设置为客户的ISN+1用以对客户的SYN报文段进行确认，SYN=1，ACK=客户ISN+1。

ACK报文段3：（客户端发送）用户必须将确认序号设置为服务器的ISN+1用以对服务器的SYN报文段进行确认，SYN=0，ACK=服务ISN+1。

##2.2、连接终止

TCP的半关闭：halfclose；
TCP的连接是全双工：数据在两个方向上能同时传递，因此每个方向必须单独地进行关闭；


当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向连接，当一端收到一个FIN，它必须通知应用层另一端已经终止了那个方向的数据传送。


收到一个FIN知识意味着在这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。



FIN报文段4：（客户端发送）FIN=1，ACK=服务端的ISN+1；
FIN的ack报文段5：（服务端发送）FIN=0，ACK=客户的ISN+1，并传送一个文件结束符，接着关闭连接；

FIN的报文段6：（服务端发送）FIN=1，ACK=客户端的ISN+1；
FIN的ack报文段7：（客户端发送）FIN=0，ACK=服务的ISN+1；


甲乙两台主机通过TCP的进行通信，甲方发送了一个带有FIN标志的数据段，所表示的含义是：
单方面释放连接，表示本方已经无数据发送，但是可以接受对方的数据

TCP采用对称释放法释放连接。任何一方想要释放连接时，发送一个FIN=1的TCP段，当这个段被确认后，这个方向的连接就释放了。当双方都发送了FIN=1的TCP段并得到了确认时，这条TCP连接就释放了。通常释放TCP连接需要4个TCP段，但第一个FIN的确认可以和第二个FIN合并，从而只需要3个段。当双方同时向对方发送FIN=1的段时，按正常方法响应，事实上同时释放和顺序释放没有什么不同。

